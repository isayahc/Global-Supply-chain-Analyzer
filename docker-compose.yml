version: "3.8"

services:
  frontend:
    image: oven/bun:1
    working_dir: /app/client
    volumes:
      - ./client:/app/client
      - frontend_dist:/app/client/dist
    environment:
      - VITE_MAPS_API_KEY=${VITE_MAPS_API_KEY}
    command: sh -c "bun install --frozen-lockfile && bun run build"

  backend:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app
        ENV PYTHONDONTWRITEBYTECODE=1
        ENV PYTHONUNBUFFERED=1
        COPY server/requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        COPY server/ .
        EXPOSE 8000
        CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
    ports:
      - "8000:8000"
    volumes:
      - frontend_dist:/app/static
    depends_on:
      frontend:
        condition: service_completed_successfully

volumes:
  frontend_dist: